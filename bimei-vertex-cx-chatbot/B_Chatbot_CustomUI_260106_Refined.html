<!--
⚠️  WARNING: This file is managed through GitHub deployments.
    Repository: https://github.com/bsuccar/bimei-vertex-cx-chatbot
    Manual changes to this file are not allowed and will be overwritten.
    All modifications must be made through the GitHub repository.
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BIMei AI Assistant - Graph Enhanced</title>
<style>
  :root{
    --coral:#f37f73;
    --bg:#f5f0ee;
    --panel:#ffffffcc;
    --text:#111;
    --muted:#6a6a6a;
    --line:rgba(0,0,0,.10);
    --shadow:0 12px 30px rgba(0,0,0,.08);
    --bimei-bg-image: url("https://bimexcellence.org/wp-content/uploads/BIMei-Page-Footer.png");
  }

  .bimei-chat-shell {
    max-width: 1100px !important;
    margin: 0 auto !important;
    padding: 0px 0px 0px !important;
    font-family: 'Raleway', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
    box-sizing: border-box !important;
    position: relative !important;
    z-index: 1000 !important;
  }

  .bimei-chat-topbar {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    gap: 16px !important;
    margin-bottom: 16px !important;
    flex-wrap: wrap !important;
  }

  .bimei-chat-topbar > div:last-child {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    white-space: nowrap !important;
  }

  .bimei-chat-topbar input[type="checkbox"] {
    margin: 0 !important;
    flex-shrink: 0 !important;
  }

  .bimei-chat-topbar label {
    font-size: 14px !important;
    color: #333 !important;
    margin: 0 !important;
    white-space: nowrap !important;
  }

  .bimei-chat-brand {
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
  }

  .bimei-chat-brand img {
    width: 44px !important;
    height: 44px !important;
    border-radius: 10px !important;
    box-shadow: 0 6px 14px rgba(0,0,0,.10) !important;
  }

  .bimei-chat-brand .bimei-title {
    line-height: 1.1 !important;
    font-style: normal !important;
  }

  .bimei-chat-brand .bimei-title b {
    font-size: 22px !important;
    font-weight: bold !important;
    font-style: normal !important;
  }

  .bimei-chat-brand .bimei-sub {
    font-size: 13px !important;
    color: var(--muted) !important;
    margin-top: 2px !important;
    font-style: normal !important;
  }

  #bimei-messages {
    position: relative !important;
    background: rgba(255,255,255,.18) !important;
    border: 1px solid rgba(255,255,255,.40) !important;
    border-radius: 22px !important;
    padding: 18px !important;
    min-height: 45vh !important;
    box-shadow: 0 18px 55px rgba(0,0,0,.18) !important;
    overflow: hidden !important;
    -webkit-backdrop-filter: blur(18px) saturate(140%) !important;
    backdrop-filter: blur(18px) saturate(140%) !important;
    margin-bottom: 14px !important;
  }

  #bimei-messages::before {
    content: "";
    position: absolute;
    inset: 0;
    background-image: var(--bimei-bg-image);
    background-size: 80%;
    background-position: right center;
    background-repeat: no-repeat;
    opacity: 0.16;
    transform: scale(1.03);
    filter: blur(2px);
    pointer-events: none;
    border-radius: 22px;
  }

  #bimei-messages::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(80% 70% at 15% 10%, rgba(255,255,255,0.40), transparent 60%),
                radial-gradient(70% 70% at 85% 15%, rgba(243,127,115,0.18), transparent 60%),
                linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
    pointer-events: none;
    border-radius: 22px;
  }

  #bimei-messages > * { position: relative; z-index: 1; }

  .bimei-chat-row {
    display: flex !important;
    gap: 14px !important;
    align-items: flex-start !important;
    margin: 10px 0 !important;
    animation: slideDown .32s cubic-bezier(.2,.9,.2,1) both !important;
  }

  .bimei-chat-row.bimei-user {
    justify-content: flex-end !important;
  }

  @keyframes slideDown{
    from{ transform: translateY(-10px); opacity: 0; }
    to{ transform: translateY(0); opacity: 1; }
  }

  .bimei-chat-avatar {
    width: 42px !important;
    height: 42px !important;
    flex: 0 0 auto !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    border: 1px solid rgba(0,0,0,.10) !important;
    box-shadow: 0 10px 22px rgba(0,0,0,.10) !important;
    background: #fff !important;
  }

  .bimei-chat-avatar img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
  }

  .bimei-chat-bubble {
    max-width: 78% !important;
    line-height: 1.3 !important;
    padding: 16px 18px !important;
    border-radius: 18px !important;
    border: 1px solid rgba(0,0,0,.10) !important;
    box-shadow: 0 14px 28px rgba(0,0,0,.08) !important;
    background: #fff !important;
    word-wrap: break-word !important;
  }

  .bimei-chat-row.bimei-user .bimei-chat-bubble {
    background: var(--coral) !important;
    color: #fff !important;
    border-color: rgba(0,0,0,.06) !important;
  }

  .bimei-chat-inputbar {
    display: flex !important;
    gap: 10px !important;
    align-items: center !important;
    margin-top: 14px !important;
    position: relative !important;
    z-index: 10 !important;
    flex-wrap: wrap !important;
  }

  #bimei-input {
    flex: 1 !important;
    min-width: 80% !important;
    resize: none !important;
    border: 1px solid rgba(0,0,0,.12) !important;
    border-radius: 16px !important;
    padding: 12px 16px !important;
    margin: 2px !important;
    font-size: 16px !important;
    line-height: 1.35 !important;
    height: 48px !important;
    box-shadow: 0 12px 26px rgba(0,0,0,.06) !important;
    outline: none !important;
    background: #fff !important;
    transition: all .2s ease !important;
    position: relative !important;
    z-index: 10 !important;
    font-family: inherit !important;
  }

  #bimei-input:focus { 
    border-color: rgba(243,127,115,.75) !important; 
    box-shadow: 0 14px 28px rgba(243,127,115,.16) !important; 
  }

  #bimei-input:hover { 
    border-color: var(--coral) !important; 
    transform: translateY(-1px) !important; 
    box-shadow: 0 16px 28px rgba(243,127,115,.16) !important; 
  }

  #bimei-send, #bimei-resetChat {
    width: 52px !important;
    min-width: 40px !important;
    height: 48px !important;
    border-radius: 14px !important;
    border: 1px solid rgba(0,0,0,.12) !important;
    background: #fff !important;
    cursor: pointer !important;
    box-shadow: 0 12px 24px rgba(0,0,0,.06) !important;
    font-size: 18px !important;
    transition: all .2s ease !important;
    color: #333 !important;
    position: relative !important;
    z-index: 10 !important;
    flex-shrink: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  #bimei-send:hover, #bimei-resetChat:hover { 
    background: var(--coral) !important; 
    color: #fff !important; 
    transform: translateY(-1px) !important; 
    box-shadow: 0 16px 28px rgba(243,127,115,.20) !important; 
  }

  #bimei-send:disabled, #bimei-resetChat:disabled { 
    opacity: .6 !important; 
    cursor: not-allowed !important; 
    transform: none !important; 
  }

  /* Evidence & Knowledge Graph */
  .bimei-evidence-section,
  .bimei-graph-section,
  .bimei-sources-section {
    background: #ffffff !important;
    border: 1px solid #e5e7eb !important;
    border-radius: 14px !important;
    padding: 22px 24px !important;
    margin-top: 18px !important;
  }

  .bimei-evidence-title,
  .bimei-graph-title,
  .bimei-sources-title {
    font-size: 18px !important;
    font-weight: 600 !important;
    color: #111827 !important;
    margin-bottom: 18px !important;
  }

  .bimei-sources-list {
    display: flex !important;
    flex-direction: column !important;
    gap: 2px !important;
  }

  .bimei-source-link a {
    color: #2563eb !important;
    text-decoration: none !important;
    font-size: 14px !important;
    word-break: break-all !important;
  }

  .bimei-source-link a:hover {
    text-decoration: underline !important;
  }

  .bimei-expert-toggle-message {
    padding: 12px 16px !important;
    margin: 10px 0 !important;
    font-size: 13px !important;
    color: #374151 !important;
    text-align: center !important;
  }

  .bimei-evidence-metrics {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    gap: 40px !important;
    flex-wrap: wrap !important;
  }

  .bimei-evidence-score-section {
    display: flex !important;
    align-items: center !important;
    gap: 14px !important;
  }

  .bimei-evidence-score {
    font-size: 42px !important;
    font-weight: 700 !important;
    line-height: 1 !important;
    color: #111827 !important;
  }

  .bimei-evidence-label {
    font-size: 13px !important;
    line-height: 1.25 !important;
    color: #374151 !important;
  }

  .bimei-evidence-stats {
    display: flex !important;
    gap: 28px !important;
    align-items: center !important;
  }

  .bimei-stat-item {
    text-align: left !important;
    min-width: 70px !important;
  }

  .bimei-stat-value {
    font-size: 20px !important;
    font-weight: 600 !important;
    color: #111827 !important;
  }

  .bimei-stat-label {
    font-size: 12px !important;
    color: #6b7280 !important;
    margin-top: 2px !important;
  }

  .bimei-graph-path {
    display: flex !important;
    align-items: center !important;
    gap: 16px !important;
    padding: 6px 0 !important;
    overflow-x: auto !important;
  }

  .bimei-graph-node {
    background: #f9fafb !important;
    border: 1px solid #d1d5db !important;
    border-radius: 10px !important;
    padding: 10px 16px !important;
    font-size: 13px !important;
    font-weight: 500 !important;
    color: #111827 !important;
    white-space: nowrap !important;
    flex-shrink: 0 !important;
  }

  .bimei-graph-connector {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    gap: 4px !important;
    flex-shrink: 0 !important;
  }

  .bimei-connector-label {
    font-size: 10px !important;
    color: #6b7280 !important;
    background: #ffffff !important;
    padding: 2px 6px !important;
    border-radius: 999px !important;
    border: 1px solid #e5e7eb !important;
  }

  .bimei-connector-arrow {
    font-size: 16px !important;
    color: #9ca3af !important;
  }

  .bimei-thinking {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
  }

  .bimei-dots {
    display: flex !important;
    gap: 4px !important;
  }

  .bimei-dot {
    width: 7px !important;
    height: 7px !important;
    border-radius: 999px !important;
    background: rgba(243,127,115,.95) !important;
    animation: bimei-dot 1s infinite ease-in-out !important;
  }

  .bimei-dot:nth-child(2) { animation-delay: 0.15s !important; }
  .bimei-dot:nth-child(3) { animation-delay: 0.3s !important; }

  @keyframes bimei-dot {
    0%, 80%, 100% { transform: scale(0.6) !important; opacity: 0.5 !important; }
    40% { transform: scale(1) !important; opacity: 1 !important; }
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .bimei-chat-shell {
      padding: 0px !important;
    }

    .bimei-chat-topbar {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 12px !important;
    }

    .bimei-chat-topbar > div:last-child {
      align-self: flex-end !important;
    }

    #bimei-messages::before {
      background-position: left bottom;
    }
    
    .bimei-chat-inputbar{
      gap: 8px !important;
    }
    
    #bimei-input{
      margin-bottom: 8px !important;
      min-height: 48px !important;
      max-height: 120px !important;
    }
    
    #bimei-send,#bimei-resetChat{
      flex: 1 !important;
      min-width: 0 !important;
    }

    .bimei-chat-bubble {
      max-width: 85% !important;
    }

    .bimei-evidence-metrics {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 18px !important;
    }

    .bimei-evidence-stats {
      gap: 20px !important;
      flex-wrap: wrap !important;
    }

    .bimei-graph-path {
      flex-direction: column !important;
      align-items: stretch !important;
    }

    .bimei-graph-connector {
      flex-direction: row !important;
      justify-content: center !important;
    }
  }

  @media (max-width: 480px) {
    .bimei-evidence-score {
      font-size: 40px !important;
    }

    .bimei-evidence-stats {
      flex-direction: column !important;
      gap: 15px !important;
    }

    .bimei-stat-item {
      min-width: auto !important;
    }
  }
</style>
</head>
<body>
<div class="bimei-chat-shell">
  <div class="bimei-chat-topbar">
    <div class="bimei-chat-brand">
      <img src="https://bimexcellence.org/wp-content/uploads/BIMei-Assistant-Logo.png" alt="">
      <div class="bimei-title">
        <b>BIMei AI Assistant</b>
        <div class="bimei-sub">Graph Enhanced JSON v0.010125</div>
      </div>
    </div>
    <div>
      <input type="checkbox" id="bimei-expertMode">
      <label for="bimei-expertMode">Show Evidence</label>
    </div>
  </div>

  <div id="bimei-messages"></div>

  <div class="bimei-chat-inputbar">
    <textarea id="bimei-input" placeholder="Ask me about BIMei" rows="1"></textarea>
    <button id="bimei-resetChat" title="Reset">↻</button>
    <button id="bimei-send" title="Send">➤</button>
  </div>
</div>

<script>
(() => {
  const messagesEl = document.getElementById('bimei-messages');
  const inputEl = document.getElementById('bimei-input');
  const sendBtn = document.getElementById('bimei-send');
  const resetBtn = document.getElementById('bimei-resetChat');
  const expertModeEl = document.getElementById('bimei-expertMode');

  const AVATAR_AI = 'https://bimexcellence.org/wp-content/uploads/BIMe-Initiative-Logo-Square.png';
  const AVATAR_USER = 'https://bimexcellence.org/wp-content/uploads/BIMei-Walkers-small.png';
  const API_URL = 'https://australia-southeast1-bimei-ai.cloudfunctions.net/bimei-chatbot';
  const sessionId = crypto.randomUUID();

  function extractGraphData(data) {
    if (!data || typeof data !== 'object') return null;
    
    // Method 1: Check for structured JSON graph data
    if (data.graph_data && data.graph_data.nodes && data.graph_data.edges) {
      return {
        nodes: data.graph_data.nodes,
        edges: data.graph_data.edges,
        hops: data.graph_data.nodes.length - 1,
        evidence: data.evidence || {},
        source: 'graph'
      };
    }
    
    return null;
  }

  function extractSources(data) {
    if (!data || typeof data !== 'object') return null;
    
    // Check for Data Store sources (links array)
    if (data.links && Array.isArray(data.links) && data.links.length > 0) {
      return {
        links: data.links.slice(0, 3), // Max 3 sources
        source: 'datastore'
      };
    }
    
    return null;
  }

  function addBubble(data, role) {
    const row = document.createElement('div');
    row.className = `bimei-chat-row ${role === 'user' ? 'bimei-user' : ''}`;

    const avatar = document.createElement('div');
    avatar.className = 'bimei-chat-avatar';
    const img = document.createElement('img');
    img.src = (role === 'ai') ? AVATAR_AI : AVATAR_USER;
    avatar.appendChild(img);

    const bubble = document.createElement('div');
    bubble.className = 'bimei-chat-bubble';
    
    if (role === 'user') {
      bubble.textContent = data.replace(/^\s*x:\s*/i, '').trim();
      row.appendChild(bubble);
      row.appendChild(avatar);
    } else {
      if (typeof data === 'object' && data.version === 'bimei-envelope-v1') {
        const content = data.content_md || '';
        
        let html = content
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/&#39;/g, "'")
          .replace(/&quot;/g, '"')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/Evidence:[\s\S]*$/i, '');
        
        bubble.innerHTML = html;
        
        if (expertModeEl.checked) {
          const graphData = extractGraphData(data);
          const sourcesData = extractSources(data);
          
          if (graphData || sourcesData) {
            const enhancedDiv = document.createElement('div');
            enhancedDiv.className = 'expert-enhancements';
            
            // Add Sources section for Data Store responses
            if (sourcesData && sourcesData.links.length > 0) {
              let sourcesHTML = `
                <div class="bimei-sources-section">
                  <div class="bimei-sources-title">Sources</div>
                  <div class="bimei-sources-list">
              `;
              
              sourcesData.links.forEach(link => {
                let title, url;
                if (typeof link === 'object' && link.title && link.url) {
                  // Use title from proxy
                  title = link.title;
                  url = link.url;
                } else {
                  // Fallback for string URLs
                  url = link;
                  title = url;
                }
                
                // Add file type indicator if needed
                let fileType = '';
                if (url.match(/\.(pdf|doc|docx|xls|xlsx|ppt|pptx)$/i)) {
                  const ext = url.match(/\.(pdf|doc|docx|xls|xlsx|ppt|pptx)$/i)[1];
                  fileType = ` (${ext.toUpperCase()})`;
                }
                
                sourcesHTML += `<div class="bimei-source-link"><a href="${url}" target="_blank">${title}${fileType}</a></div>`;
              });
              
              sourcesHTML += '</div></div>';
              enhancedDiv.innerHTML += sourcesHTML;
            }
            
            // Add Evidence and Graph sections for Knowledge Graph responses
            if (graphData && graphData.nodes && graphData.nodes.length > 1) {
              let evidenceHTML = `
                <div class="bimei-evidence-section">
                  <div class="bimei-evidence-title">Evidence</div>
                  <div class="bimei-evidence-metrics">
                    <div class="bimei-evidence-score-section">
                      <span class="bimei-evidence-score">${graphData.evidence?.score || '10.0'}</span>
                      <span class="bimei-evidence-label">${graphData.evidence?.confidence || 'High'}<br>${graphData.evidence?.semantic_type || 'Semantic Evidence'}</span>
                    </div>
                    <div class="bimei-evidence-stats">
                      <div class="bimei-stat-item">
                        <div class="bimei-stat-value">${graphData.evidence?.metrics?.hops || graphData.hops}</div>
                        <div class="bimei-stat-label">hops</div>
                      </div>
                      <div class="bimei-stat-item">
                        <div class="bimei-stat-value">${graphData.evidence?.metrics?.raw || '1.149'}</div>
                        <div class="bimei-stat-label">raw</div>
                      </div>
                      <div class="bimei-stat-item">
                        <div class="bimei-stat-value">${graphData.evidence?.metrics?.normalised || '1'}</div>
                        <div class="bimei-stat-label">normalised</div>
                      </div>
                      <div class="bimei-stat-item">
                        <div class="bimei-stat-value">${graphData.evidence?.metrics?.decay || '0.247'}</div>
                        <div class="bimei-stat-label">decay</div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
              
              let graphHTML = `
                <div class="bimei-graph-section">
                  <div class="bimei-graph-title">Knowledge Graph Path</div>
                  <div class="bimei-graph-path">
              `;
              
              graphData.nodes.forEach((node, i) => {
                graphHTML += `<div class="bimei-graph-node">${node.label}</div>`;
                if (i < graphData.nodes.length - 1) {
                  const edge = graphData.edges && graphData.edges[i] ? graphData.edges[i] : { relation: 'CONNECTS_TO' };
                  const edgeType = edge.relation || edge.type || 'CONNECTS_TO';
                  graphHTML += `
                    <div class="bimei-graph-connector">
                      <div class="bimei-connector-label">(${edgeType})</div>
                      <div class="bimei-connector-arrow">→</div>
                    </div>
                  `;
                }
              });
              
              graphHTML += '</div></div>';
              
              enhancedDiv.innerHTML += evidenceHTML + graphHTML;
            }
            
            bubble.appendChild(enhancedDiv);
          }
        }
      } else {
        bubble.textContent = typeof data === 'string' ? data : JSON.stringify(data);
      }
      
      row.appendChild(avatar);
      row.appendChild(bubble);
    }

    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return { row, bubble };
  }

  function addThinkingBubble() {
    const row = document.createElement('div');
    row.className = 'bimei-chat-row';

    const avatar = document.createElement('div');
    avatar.className = 'bimei-chat-avatar';
    const img = document.createElement('img');
    img.src = AVATAR_AI;
    avatar.appendChild(img);

    const bubble = document.createElement('div');
    bubble.className = 'bimei-chat-bubble';
    bubble.innerHTML = `
      <div class="bimei-thinking">
        <span>Thinking...</span>
        <div class="bimei-dots">
          <div class="bimei-dot"></div>
          <div class="bimei-dot"></div>
          <div class="bimei-dot"></div>
        </div>
      </div>`;

    row.appendChild(avatar);
    row.appendChild(bubble);
    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return { row, bubble };
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    const expert = expertModeEl.checked;
    const payloadText = text; // Don't add x: prefix for expert mode

    addBubble(text, 'user');
    inputEl.value = '';

    const thinking = addThinkingBubble();
    sendBtn.disabled = true;

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          action: 'vertex-proxy',
          sessionId, 
          messages: [{ content: payloadText }],
          expertMode: expert
        })
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();
      
      const responseData = (data.envelope && data.envelope.version === 'bimei-envelope-v1') 
        ? data.envelope 
        : data.text || 'No response';
      
      thinking.row.remove();
      addBubble(responseData, 'ai');

    } catch (error) {
      thinking.bubble.textContent = `Error: ${error.message}`;
    } finally {
      sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  resetBtn.addEventListener('click', () => {
    messagesEl.innerHTML = '';
  });

  expertModeEl.addEventListener('change', (e) => {
    const message = e.target.checked 
      ? 'Expert Mode activated - sources, evidence and paths will be shown if applicable'
      : 'Expert Mode deactivated - no sources, evidence or paths will be shown';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'bimei-expert-toggle-message';
    messageDiv.textContent = message;
    messagesEl.appendChild(messageDiv);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  setTimeout(() => {
    addBubble('Welcome! Ask me about BIMei materials. Remember that we are still in Beta!', 'ai');
  }, 500);
})();
</script>
</body>
</html>