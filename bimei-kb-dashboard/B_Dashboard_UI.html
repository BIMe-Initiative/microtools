<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BIMei Knowledge Explorer</title>

  <!-- Vis-Network for graph visualization -->
  <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/dist/dist/vis-network.min.css" rel="stylesheet" type="text/css" />

  <!-- Google Fonts - Raleway (multiple weights) -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#f37f73",
            "background-light": "#fbfcfd",
            "background-dark": "#0f172a",
            "card-light": "#ffffff",
            "card-dark": "#1e293b",
          },
          fontFamily: {
            sans: ["Raleway", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "12px",
          },
        },
      },
    };
  </script>

  <style type="text/tailwindcss">
    body { font-family: 'Raleway', sans-serif; }

    /* Custom scrollbar styling */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }

    /* Section spacing */
    .section-gap {
      @apply pb-4 mb-0;
    }

    /* Loading spinner animation */
    @keyframes bimei-kb-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .bimei-kb-loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #f37f73;
      border-radius: 50%;
      animation: bimei-kb-spin 1s linear infinite;
    }

    /* Vis-network tooltip styling */
    div.vis-tooltip {
      background-color: #ffffff !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 5px !important;
      font-family: 'Raleway', sans-serif !important;
      padding: 8px 12px !important;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }

    /* Vis-network graph control customization - BIMei Coral */
    div.vis-network div.vis-navigation div.vis-button {
      background-color: rgba(243, 127, 115, 0.1) !important;
      border: 1px solid #f37f73 !important;
    }

    div.vis-network div.vis-navigation div.vis-button:hover {
      background-color: rgba(243, 127, 115, 0.2) !important;
      box-shadow: 0 0 3px 3px rgba(243, 127, 115, 0.3) !important;
    }

    /* Coral SVG icons for vis-network controls */
    div.vis-network div.vis-navigation div.vis-button.vis-up {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath fill='%23f37f73' d='M15 10 L20 17 L10 17 Z'/%3E%3C/svg%3E") !important;
    }

    div.vis-network div.vis-navigation div.vis-button.vis-down {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath fill='%23f37f73' d='M15 20 L20 13 L10 13 Z'/%3E%3C/svg%3E") !important;
    }

    div.vis-network div.vis-navigation div.vis-button.vis-left {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath fill='%23f37f73' d='M10 15 L17 10 L17 20 Z'/%3E%3C/svg%3E") !important;
    }

    div.vis-network div.vis-navigation div.vis-button.vis-right {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath fill='%23f37f73' d='M20 15 L13 10 L13 20 Z'/%3E%3C/svg%3E") !important;
    }

    div.vis-network div.vis-navigation div.vis-button.vis-zoomIn {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Ccircle cx='13' cy='13' r='7' fill='none' stroke='%23f37f73' stroke-width='2'/%3E%3Cline x1='13' y1='10' x2='13' y2='16' stroke='%23f37f73' stroke-width='2'/%3E%3Cline x1='10' y1='13' x2='16' y2='13' stroke='%23f37f73' stroke-width='2'/%3E%3Cline x1='18' y1='18' x2='22' y2='22' stroke='%23f37f73' stroke-width='2'/%3E%3C/svg%3E") !important;
    }

    div.vis-network div.vis-navigation div.vis-button.vis-zoomOut {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Ccircle cx='13' cy='13' r='7' fill='none' stroke='%23f37f73' stroke-width='2'/%3E%3Cline x1='10' y1='13' x2='16' y2='13' stroke='%23f37f73' stroke-width='2'/%3E%3Cline x1='18' y1='18' x2='22' y2='22' stroke='%23f37f73' stroke-width='2'/%3E%3C/svg%3E") !important;
    }

    div.vis-network div.vis-navigation div.vis-button.vis-zoomExtends {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Crect x='8' y='8' width='14' height='14' fill='none' stroke='%23f37f73' stroke-width='2'/%3E%3Cpath d='M10 12 L12 10 M18 12 L20 10 M12 18 L10 20 M18 18 L20 20' stroke='%23f37f73' stroke-width='2' fill='none'/%3E%3C/svg%3E") !important;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-200 selection:bg-primary/20">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/80 dark:bg-card-dark/80 backdrop-blur-md border-b border-slate-100 dark:border-slate-800">
    <div class="max-w-[1000px] mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <img
          src="https://bimexcellence.org/wp-content/uploads/BIMei-Assistant-Logo.png"
          alt="BIMei Logo"
          class="h-9 w-auto"
          onerror="this.style.display='none'"
        />
        <div>
          <h1 class="text-lg font-extrabold tracking-tight">BIMei <span class="text-slate-400 font-medium">Knowledge Explorer</span></h1>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2 bg-slate-50 dark:bg-slate-800 px-3 py-1 rounded-full border border-slate-100 dark:border-slate-700">
          <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
          <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">v1.0.5</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-[1000px] mx-auto p-6 md:p-12">
    <!-- Query Bar -->
    <div class="mb-12">
      <div class="relative group">
        <span class="material-symbols-outlined absolute left-5 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-primary transition-colors">manage_search</span>
        <input
          class="w-full bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-2xl py-5 pl-14 pr-40 focus:ring-4 focus:ring-primary/10 focus:border-primary/30 text-lg transition-all shadow-2xl shadow-slate-200/40 dark:shadow-none"
          placeholder="Investigate BIMei knowledge space..."
          type="text"
          id="bimei-kb-query-input"
          autocomplete="off"
        />
        <button
          id="bimei-kb-submit-btn"
          class="absolute right-3 top-1/2 -translate-y-1/2 bg-primary text-white px-8 py-2.5 rounded-xl font-bold text-sm hover:brightness-110 transition-all shadow-lg shadow-primary/20"
        >
          Investigate
        </button>
      </div>
    </div>

    <!-- Response & Evidence Section -->
    <div class="section-gap">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-10 md:items-start">
        <!-- Response Module -->
        <section class="md:col-span-12" id="module-text">
          <div class="flex items-center space-x-2 mb-4">
            <span class="material-symbols-outlined text-primary">auto_awesome</span>
            <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">Response</h2>
          </div>
          <div class="flex space-x-4 text-[10px] font-bold text-slate-400 uppercase tracking-[0.15em] mb-4">
            <span>SOURCE: <span class="text-slate-900 dark:text-slate-200">BIMei Graph</span></span>
            <span>MODE: <span class="text-slate-900 dark:text-slate-200">Expert</span></span>
            <span id="status-text" class="hidden"></span>
          </div>
          <div id="content-text" class="text-lg text-slate-700 dark:text-slate-300 leading-relaxed bg-white dark:bg-slate-800/40 p-8 rounded-3xl border border-slate-50 dark:border-slate-800/50 shadow-sm min-h-[200px] flex items-center justify-center empty:text-slate-400 empty:italic">
            Enter a query to get started
          </div>
        </section>

        <!-- Evidence Module -->
        <section class="md:col-span-12 flex flex-col" id="module-evidence">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-2">
              <span class="material-symbols-outlined text-primary">analytics</span>
              <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">Evidence</h2>
            </div>
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.15em]">Idle</span>
          </div>
          <div class="h-[28px] mb-4"></div>
          <div id="content-evidence" class="bg-white dark:bg-slate-800/40 rounded-3xl border border-slate-50 dark:border-slate-800/50 shadow-sm p-8 min-h-[200px] flex-1 flex flex-col items-center justify-center empty:text-slate-400 empty:italic">
            Evidence metrics will appear here
          </div>
        </section>
      </div>
    </div>

    <!-- Sources Section -->
    <section class="section-gap" id="module-sources">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-2">
          <span class="material-symbols-outlined text-primary">menu_book</span>
          <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">Sources</h2>
        </div>
        <span id="status-sources" class="hidden"></span>
      </div>
      <div id="content-sources" class="flex flex-wrap gap-6 bg-white dark:bg-slate-800/40 rounded-3xl border border-slate-50 dark:border-slate-800/50 p-6 min-h-[150px] empty:flex empty:items-center empty:justify-center empty:text-slate-400 empty:italic">
        Sources will appear here
      </div>
    </section>

    <!-- Knowledge Path Section -->
    <section class="section-gap" id="module-path">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-2">
          <span class="material-symbols-outlined text-primary">account_tree</span>
          <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">Knowledge Path</h2>
        </div>
        <span id="status-path" class="hidden"></span>
      </div>
      <div id="content-path" class="bg-white dark:bg-slate-800/40 rounded-3xl border border-slate-50 dark:border-slate-800/50 shadow-sm p-8 min-h-[200px] flex items-center justify-center empty:text-slate-400 empty:italic">
        Knowledge path will appear here
      </div>
    </section>

    <!-- Interactive Graph Section -->
    <section class="section-gap" id="module-graph">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-2">
          <span class="material-symbols-outlined text-primary">bubble_chart</span>
          <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">Interactive Graph</h2>
        </div>
        <span id="status-graph" class="hidden"></span>
      </div>
      <div id="content-graph" class="relative bg-white dark:bg-slate-900/40 rounded-3xl border border-slate-100 dark:border-slate-800 h-[750px] overflow-y-auto shadow-sm flex items-center justify-center empty:text-slate-400 empty:italic px-2.5 pt-6 pb-6">
        Interactive graph will appear here
      </div>
    </section>
  </main>

  <script>
    // BIMei KB Dashboard - Module System
    class BIMeiDashboard {
      constructor() {
        this.modules = new Map();
        this.eventBus = new EventTarget();
        this.sessionId = this.generateSessionId();
        this.config = {
          apiEndpoint: 'https://australia-southeast1-bimei-ai.cloudfunctions.net/dashboardApi'
        };
        this.state = {
          query: '',
          loading: false,
          results: {}
        };

        this.init();
      }

      generateSessionId() {
        return 'dash_' + Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
      }

      init() {
        // Register core modules
        this.registerModule('text', new TextResponseModule());
        this.registerModule('sources', new SourcesModule());
        this.registerModule('evidence', new EvidenceModule());
        this.registerModule('path', new PathVisualizationModule());
        this.registerModule('graph', new InteractiveGraphModule());

        // Setup event listeners
        this.setupEventListeners();

        console.log('BIMei KB Dashboard initialized');
      }

      registerModule(name, moduleInstance) {
        this.modules.set(name, moduleInstance);
        moduleInstance.dashboard = this;
        moduleInstance.init();
      }

      setupEventListeners() {
        const input = document.getElementById('bimei-kb-query-input');
        const submitBtn = document.getElementById('bimei-kb-submit-btn');

        submitBtn.addEventListener('click', () => this.handleQuery());
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.handleQuery();
        });
      }

      async handleQuery() {
        console.log('Dashboard: Starting query...');
        const input = document.getElementById('bimei-kb-query-input');
        const query = input.value.trim();
        
        if (!query) {
          console.log('Dashboard: Empty query, aborting');
          return;
        }

        console.log('Dashboard: Query:', query);
        this.state.query = query;
        this.state.loading = true;
        
        // Update UI
        document.getElementById('bimei-kb-submit-btn').disabled = true;
        
        // Notify all modules
        console.log('Dashboard: Notifying modules of query start');
        this.eventBus.dispatchEvent(new CustomEvent('query-start', { 
          detail: { query } 
        }));

        try {
          console.log('Dashboard: Making API call to:', this.config.apiEndpoint);
          // Real API call to unified endpoint
          const response = await fetch(this.config.apiEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              query,
              modules: ['text', 'sources', 'evidence', 'path', 'graph'],
              sessionId: this.sessionId
            })
          });

          console.log('Dashboard: API response status:', response.status);
          if (!response.ok) {
            throw new Error(`API call failed: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          console.log('Dashboard: Full API response structure:', JSON.stringify(data, null, 2));
          console.log('Dashboard: Results object:', data.results);
          
          // Check if we actually have real data or if API failed
          if (!data.results || Object.keys(data.results).length === 0) {
            throw new Error('API returned empty results');
          }
          
          this.state.results = data.results;
          
          console.log('Dashboard: Notifying modules of query complete');
          this.eventBus.dispatchEvent(new CustomEvent('query-complete', { 
            detail: { query, results: data.results } 
          }));
          
        } catch (error) {
          console.error('Dashboard: Query failed:', error);
          this.eventBus.dispatchEvent(new CustomEvent('query-error', { 
            detail: { query, error } 
          }));
        } finally {
          this.state.loading = false;
          document.getElementById('bimei-kb-submit-btn').disabled = false;
          console.log('Dashboard: Query processing complete');
        }
      }

      updateModuleStatus(moduleName, status) {
        const statusEl = document.getElementById(`status-${moduleName}`);
        if (statusEl) {
          statusEl.className = `bimei-kb-module-status bimei-kb-status-${status}`;
          statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
      }

      updateModuleContent(moduleName, content) {
        const contentEl = document.getElementById(`content-${moduleName}`);
        if (contentEl) {
          // Remove 'empty' class when populating with content
          contentEl.classList.remove('empty');

          if (typeof content === 'string') {
            contentEl.innerHTML = content;
          } else {
            contentEl.appendChild(content);
          }
        }
      }
    }

    // Base Module Class
    class BaseModule {
      constructor() {
        this.dashboard = null;
        this.state = { loading: false, data: null, error: null };
      }

      init() {
        this.dashboard.eventBus.addEventListener('query-start', (e) => this.onQueryStart(e.detail));
        this.dashboard.eventBus.addEventListener('query-complete', (e) => this.onQueryComplete(e.detail));
        this.dashboard.eventBus.addEventListener('query-error', (e) => this.onQueryError(e.detail));
      }

      onQueryStart(detail) {
        this.state.loading = true;
        this.state.error = null;
        this.updateStatus('loading');
        this.showLoading();
      }

      onQueryComplete(detail) {
        this.state.loading = false;
        // Override in subclasses
      }

      hideModule() {
        const moduleSection = document.getElementById(`module-${this.getModuleName()}`);
        if (moduleSection) {
          moduleSection.style.display = 'none';
        }
      }

      showModule() {
        const moduleSection = document.getElementById(`module-${this.getModuleName()}`);
        if (moduleSection) {
          moduleSection.style.display = '';
        }
      }

      onQueryError(detail) {
        this.state.loading = false;
        this.state.error = detail.error;
        this.updateStatus('error');
        this.showError(detail.error);
      }

      updateStatus(status) {
        // Only show error and loading status, hide success
        if (status !== 'success') {
          this.dashboard.updateModuleStatus(this.getModuleName(), status);
        } else {
          // Hide status badge for success
          this.dashboard.updateModuleStatus(this.getModuleName(), 'idle');
        }
      }

      updateContent(content) {
        this.dashboard.updateModuleContent(this.getModuleName(), content);
      }

      showLoading() {
        const loadingHtml = `
          <div class="flex flex-col items-center justify-center gap-4 text-slate-400">
            <div class="text-base italic">${this.getLoadingMessage()}</div>
            <div class="bimei-kb-loading-spinner"></div>
          </div>
        `;
        this.updateContent(loadingHtml);
      }

      getLoadingMessage() {
        const moduleName = this.getModuleName();
        const messages = {
          'text': 'Generating response...',
          'sources': 'Retrieving sources...',
          'evidence': 'Calculating evidence...',
          'path': 'Finding knowledge path...',
          'graph': 'Building interactive graph...'
        };
        return messages[moduleName] || 'Loading...';
      }

      showError(error) {
        this.updateContent(`<div class="bimei-kb-error-message">Error: ${error.message || error}</div>`);
      }

      getModuleName() {
        // Override in subclasses
        return 'base';
      }
    }

    // Module Implementations (Enhanced for Phase 3)
    class TextResponseModule extends BaseModule {
      getModuleName() { return 'text'; }
      
      onQueryComplete(detail) {
        console.log('TextModule: Received query complete:', detail);
        super.onQueryComplete(detail);
        const textData = detail.results?.text;
        console.log('TextModule: Text data:', textData);
        
        if (textData && !textData.error) {
          this.updateStatus('success');
          const content = this.formatTextResponse(textData, detail.query);
          this.updateContent(content);
        } else {
          this.updateStatus('error');
          this.updateContent(`<div class="bimei-kb-error-message">${textData?.error || 'No response available'}</div>`);
        }
      }
      
      formatTextResponse(data, query) {
        let content = data.content || 'No content available';
        const source = data.source || 'BIMei AI';
        const mode = data.mode || 'default';

        // Strip "Evidence:" section and everything after it (including links)
        content = content.replace(/\n*Evidence:\s*\n[\s\S]*$/i, '');

        const wordCount = content.split(/\s+/).length;

        // Store content in a data attribute for copying
        const copyBtnId = 'copy-text-' + Math.random().toString(36).substr(2, 9);

        // Set up copy button click handler
        setTimeout(() => {
          const btn = document.getElementById(copyBtnId);
          if (btn) {
            btn.addEventListener('click', () => {
              // Strip HTML tags and markdown formatting for plain text copy
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = content;
              let plainText = tempDiv.textContent || tempDiv.innerText || '';

              // Strip markdown formatting
              plainText = plainText
                .replace(/\*\*(.*?)\*\*/g, '$1')  // Remove **bold**
                .replace(/\*(.*?)\*/g, '$1')      // Remove *italic*
                .replace(/`([^`]+)`/g, '$1')      // Remove `code`
                .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')  // Remove [links](url)
                .replace(/#{1,6}\s*/g, '')        // Remove # headers
                .trim();

              navigator.clipboard.writeText(plainText).then(() => {
                btn.textContent = '‚úì Copied';
                setTimeout(() => { btn.textContent = 'üìã Copy'; }, 2000);
              });
            });
          }
        }, 100);

        return `
          <div style="line-height: 1.6; color: #2d3748; overflow-wrap: break-word; word-wrap: break-word;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; font-size: 12px; color: #718096;">
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <span><strong>Source:</strong> ${this.escapeHtml(source)}</span>
                <span><strong>Mode:</strong> ${mode}</span>
                <span><strong>Words:</strong> ${wordCount}</span>
              </div>
              <button id="${copyBtnId}" style="font-size: 11px; padding: 4px 8px; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 4px; cursor: pointer;">üìã Copy</button>
            </div>
            <div style="overflow-wrap: break-word; word-wrap: break-word;">${this.parseMarkdown(content)}</div>
          </div>
        `;
      }
      
      parseMarkdown(text) {
        return text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/`([^`]+)`/g, '<code style="background: #f1f5f9; padding: 2px 4px; border-radius: 3px; font-size: 0.9em;">$1</code>')
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>')
          .replace(/^/, '<p>')
          .replace(/$/, '</p>');
      }
      
      escapeHtml(text) {
        return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
      }
      
      escapeForJs(text) {
        return String(text).replace(/'/g, "\\''").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
      }
    }

    class SourcesModule extends BaseModule {
      getModuleName() { return 'sources'; }
      
      onQueryComplete(detail) {
        console.log('SourcesModule: Received query complete:', detail);
        super.onQueryComplete(detail);
        const sourcesData = detail.results?.sources;
        console.log('SourcesModule: Sources data:', sourcesData);

        if (sourcesData && !sourcesData.error && sourcesData.links?.length > 0) {
          this.showModule();
          this.updateStatus('success');
          const content = this.formatSources(sourcesData.links);
          this.updateContent(content);
        } else if (sourcesData?.error) {
          this.showModule();
          this.updateStatus('error');
          this.updateContent(`<div class="bimei-kb-error-message">${sourcesData.error}</div>`);
        } else {
          this.hideModule();
        }
      }
      
      formatSources(links) {
        const sourcesList = links.map(link => {
          const typeIcon = this.getTypeIcon(link.type);
          let title = link.title || link.url;

          // Strip [Dictionary], [Page], [PDF] prefixes from title
          title = title.replace(/^\[(Dictionary|Page|PDF)\]\s*/i, '');

          return `
            <div style="flex: 1; min-width: 250px; max-width: 400px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #ffffff; transition: all 0.2s ease; cursor: pointer;"
                 onmouseover="this.style.borderColor='#f37f73'; this.style.boxShadow='0 4px 6px -1px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';"
                 onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'; this.style.transform='translateY(0)';"
                 onclick="window.open('${link.url}', '_blank')">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                <span style="font-size: 24px;">${typeIcon}</span>
                <span style="font-size: 11px; color: #718096; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">${link.type}</span>
              </div>
              <div style="color: #f37f73; font-size: 14px; line-height: 1.4; font-weight: 500;">
                ${title}
              </div>
            </div>
          `;
        }).join('');

        return sourcesList;
      }
      
      getTypeIcon(type) {
        const icons = {
          'dictionary': 'üìö',
          'pdf': 'üìÑ',
          'page': 'üåê',
          'external': 'üîó'
        };
        return icons[type] || 'üìÑ';
      }
    }

    class EvidenceModule extends BaseModule {
      getModuleName() { return 'evidence'; }
      
      onQueryComplete(detail) {
        console.log('EvidenceModule: Received query complete:', detail);
        super.onQueryComplete(detail);
        const evidenceData = detail.results?.evidence;
        console.log('EvidenceModule: Evidence data:', evidenceData);

        // Hide module if score is 0 or tier is minimal
        if (evidenceData && (evidenceData.score === 0 || evidenceData.tier === 'minimal')) {
          this.hideModule();
          return;
        }

        if (evidenceData && !evidenceData.error) {
          this.showModule();
          this.updateStatus('success');
          const content = this.formatEvidence(evidenceData);
          this.updateContent(content);
        } else if (evidenceData?.error) {
          this.showModule();
          this.updateStatus('error');
          this.updateContent(`<div class="bimei-kb-error-message">${evidenceData.error}</div>`);
        } else {
          this.hideModule();
        }
      }
      
      formatEvidence(data) {
        const score = data.score || 0;
        const confidence = data.confidence || 'Unknown';
        const tier = data.tier || 'minimal';
        const metrics = data.metrics || {};
        
        const tierColor = this.getTierColor(tier);
        
        return `
          <div style="text-align: center;">
            <div style="font-size: 36px; font-weight: 700; color: #2d3748; margin-bottom: 8px;">
              ${score.toFixed(1)}
            </div>
            <div style="font-size: 14px; color: ${tierColor}; font-weight: 600; margin-bottom: 16px;">
              ${confidence} Confidence
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
              <div>
                <div style="font-weight: 600; color: #4a5568;">${metrics.hops || 0}</div>
                <div style="color: #718096;">Hops</div>
              </div>
              <div>
                <div style="font-weight: 600; color: #4a5568;">${(metrics.normalised || 0).toFixed(2)}</div>
                <div style="color: #718096;">Normalised</div>
              </div>
              <div>
                <div style="font-weight: 600; color: #4a5568;">${(metrics.raw || 0).toFixed(2)}</div>
                <div style="color: #718096;">Raw Score</div>
              </div>
              <div>
                <div style="font-weight: 600; color: #4a5568;">${(metrics.decay || 0).toFixed(2)}</div>
                <div style="color: #718096;">Decay</div>
              </div>
            </div>
          </div>
        `;
      }
      
      getTierColor(tier) {
        const colors = {
          'high': '#38a169',
          'medium': '#d69e2e',
          'low': '#e53e3e',
          'minimal': '#718096'
        };
        return colors[tier] || '#718096';
      }
    }

    class PathVisualizationModule extends BaseModule {
      getModuleName() { return 'path'; }
      
      onQueryComplete(detail) {
        console.log('PathModule: Received query complete:', detail);
        super.onQueryComplete(detail);
        const pathData = detail.results?.path;
        console.log('PathModule: Path data:', pathData);

        if (pathData && !pathData.error && pathData.nodes?.length > 0) {
          this.showModule();
          this.updateStatus('success');
          const content = this.formatPath(pathData);
          this.updateContent(content);
        } else if (pathData?.error) {
          this.showModule();
          this.updateStatus('error');
          this.updateContent(`<div class="bimei-kb-error-message">${pathData.error}</div>`);
        } else {
          this.hideModule();
        }
      }
      
      formatPath(data) {
        const nodes = data.nodes || [];
        const edges = data.edges || [];
        const hops = data.hops || 0;

        console.log('formatPath called with data:', { nodes, edges, hops });
        console.log('Node details:', nodes.map((n, i) => ({ index: i, id: n.id, type: n.type, label: n.label })));

        const pathExpandId = `expand-path-${Date.now()}`;
        let pathHtml = `
          <div style="margin-bottom: 16px;" id="path-container-${pathExpandId}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 12px; color: #718096; gap: 12px;">
              <span>${nodes.length} nodes, ${hops} hops</span>
              <button id="${pathExpandId}" style="display: none; font-size: 11px; padding: 4px 8px; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 4px; cursor: pointer;">üîç Expand</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; align-items: center; max-height: 300px; overflow-y: auto; padding: 8px;" id="path-content-${pathExpandId}">
        `;

        nodes.forEach((node, i) => {
          const nodeType = node.type || 'Unknown';
          const nodeColor = this.getNodeColor(nodeType);
          
          pathHtml += `
            <div style="background: ${nodeColor}; color: white; border-radius: 8px; padding: 10px 14px; font-size: 13px; font-weight: 500; text-align: center; max-width: 250px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;" title="Type: ${nodeType}\nID: ${node.id || 'N/A'}">
              <div style="font-size: 10px; opacity: 0.8; margin-bottom: 2px;">${nodeType}</div>
              <div>${this.escapeHtml(node.label || node.id)}</div>
            </div>
          `;
          
          if (i < edges.length) {
            const edge = edges[i];
            const relation = edge.relation || edge.type || 'CONNECTS';
            pathHtml += `
              <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; margin: 4px 0;">
                <div style="font-size: 10px; color: #718096; background: white; padding: 3px 8px; border-radius: 12px; border: 1px solid #e2e8f0; font-weight: 600;">
                  ${relation}
                </div>
                <div style="color: #cbd5e0; font-size: 16px; line-height: 1;">‚Üì</div>
              </div>
            `;
          }
        });
        
        pathHtml += `
            </div>
            <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #f1f5f9; font-size: 11px; color: #a0aec0; text-align: center;">
              Knowledge path visualization
            </div>
          </div>
        `;

        // Store query for expand button and attach listener
        setTimeout(() => {
          const expandBtn = document.getElementById(pathExpandId);
          if (expandBtn) {
            expandBtn.addEventListener('click', () => {
              this.expandAlternativePaths(pathExpandId, nodes);
            });
          }
        }, 100);

        return pathHtml;
      }

      async expandAlternativePaths(pathExpandId, currentNodes) {
        const expandBtn = document.getElementById(pathExpandId);
        if (!expandBtn) {
          console.error('Expand button not found:', pathExpandId);
          return;
        }

        expandBtn.textContent = '‚è≥ Loading...';
        expandBtn.disabled = true;

        try {
          // Get first and last nodes from current path
          const startNode = currentNodes[0];
          const endNode = currentNodes[currentNodes.length - 1];

          console.log('Expanding path from:', startNode, 'to:', endNode);

          if (!startNode || !endNode) {
            throw new Error('Invalid path nodes');
          }

          // Fetch alternative paths from GraphQuery
          const requestBody = {
            xBest: { id: startNode.id, type: startNode.type, label: startNode.label },
            yBest: { id: endNode.id, type: endNode.type, label: endNode.label },
            maxPaths: 5  // Request up to 5 alternative paths
          };

          console.log('Fetching alternative paths:', requestBody);

          const response = await fetch('https://graphquery-jilezw5qqq-uc.a.run.app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });

          console.log('GraphQuery response status:', response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('GraphQuery error:', errorText);
            throw new Error(`Failed to fetch alternative paths: ${response.status}`);
          }

          const data = await response.json();
          const paths = data.paths || [];

          if (paths.length <= 1) {
            expandBtn.textContent = '‚úì No alternatives';
            setTimeout(() => {
              expandBtn.textContent = 'üîç Expand';
              expandBtn.disabled = false;
            }, 2000);
            return;
          }

          // Render alternative paths
          const pathContent = document.getElementById(`path-content-${pathExpandId}`);
          if (!pathContent) return;

          let altPathsHtml = '';
          paths.slice(1, 4).forEach((path, idx) => {  // Show up to 3 alternatives
            altPathsHtml += `
              <div style="margin-top: 16px; padding: 12px; background: #fef5e7; border: 1px solid #f6d186; border-radius: 8px;">
                <div style="font-size: 11px; font-weight: 600; color: #d69e2e; margin-bottom: 8px;">
                  ALTERNATIVE PATH ${idx + 1} (${path.hop_count || 0} hops)
                </div>
                <div style="display: flex; gap: 6px; flex-wrap: wrap; font-size: 11px;">
            `;

            (path.nodes || []).forEach((node, i) => {
              const nodeType = node.type || 'Unknown';
              const nodeColor = this.getNodeColor(nodeType);

              altPathsHtml += `
                <div style="background: ${nodeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">
                  ${this.escapeHtml(node.label || node.id)}
                </div>
              `;

              if (i < (path.rels || []).length) {
                altPathsHtml += `<div style="color: #a0aec0;">‚Üí</div>`;
              }
            });

            altPathsHtml += `
                </div>
              </div>
            `;
          });

          pathContent.insertAdjacentHTML('beforeend', altPathsHtml);

          expandBtn.textContent = `‚úì +${paths.length - 1} paths`;
          expandBtn.style.background = '#f0fff4';
          expandBtn.style.color = '#38a169';
          expandBtn.disabled = true;

        } catch (error) {
          console.error('Error expanding alternative paths:', error);
          expandBtn.textContent = '‚úó Failed';
          expandBtn.style.background = '#fed7d7';
          expandBtn.style.color = '#e53e3e';
          setTimeout(() => {
            expandBtn.textContent = 'üîç Expand';
            expandBtn.style.background = '#f8fafc';
            expandBtn.style.color = 'inherit';
            expandBtn.disabled = false;
          }, 3000);
        }
      }
      
      getNodeColor(type) {
        const colors = {
          'Construct': '#3182ce',
          'InformationUse': '#e53e3e',
          'ActionStatement': '#38a169',
          'DictionaryItem': '#d69e2e',
          'Content': '#805ad5',
          'Deliverable': '#dd6b20',
          'Resource': '#319795'
        };
        return colors[type] || '#718096';
      }
      
      escapeHtml(text) {
        return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
      }
    }

    class InteractiveGraphModule extends BaseModule {
      getModuleName() { return 'graph'; }
      
      onQueryComplete(detail) {
        console.log('GraphModule: Received query complete:', detail);
        super.onQueryComplete(detail);
        const graphData = detail.results?.graph;
        console.log('GraphModule: Graph data:', graphData);

        // Hide module if there are no edges in the graph
        if (graphData && graphData.visual && graphData.visual.edges && graphData.visual.edges.length === 0) {
          this.hideModule();
          return;
        }

        if (graphData && !graphData.error) {
          this.showModule();
          this.updateStatus('success');
          const content = this.formatGraph(graphData);
          this.updateContent(content);
        } else if (graphData?.error) {
          this.showModule();
          this.updateStatus('error');
          this.updateContent(`<div class="bimei-kb-error-message">${graphData.error}</div>`);
        } else {
          this.hideModule();
        }
      }
      
      formatGraph(data) {
        const answer = data.answer || 'No answer available';
        const cypher = data.cypher || '';
        const visual = data.visual || { nodes: [], edges: [] };
        const isAggregation = data.isAggregation || false;

        console.log('formatGraph called with data:', data);
        console.log('Cypher value:', cypher);
        console.log('Cypher length:', cypher.length);

        // Generate unique container ID
        const graphId = 'graph-viz-' + Math.random().toString(36).substr(2, 9);

        // Render the graph after DOM is ready
        setTimeout(() => this.renderVisNetwork(graphId, visual), 100);

        // Setup copy button event listener
        setTimeout(() => {
          const copyBtn = document.getElementById(`copy-cypher-btn-${graphId}`);
          if (copyBtn) {
            copyBtn.addEventListener('click', function() {
              const cypherText = this.getAttribute('data-cypher-text');
              // Decode HTML entities
              const textarea = document.createElement('textarea');
              textarea.innerHTML = cypherText;
              const decodedText = textarea.value;

              navigator.clipboard.writeText(decodedText).then(() => {
                this.innerHTML = '‚úì Copied';
                setTimeout(() => this.innerHTML = 'üìã Copy', 2000);
              }).catch(err => {
                console.error('Copy failed:', err);
                this.innerHTML = '‚úó Failed';
                setTimeout(() => this.innerHTML = 'üìã Copy', 2000);
              });
            });
          }
        }, 100);

        return `
          <div>
            <div style="margin-bottom: 16px; padding: 14px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 10px; border: 1px solid #e2e8f0;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="font-size: 14px; font-weight: 600; color: #2d3748;">Graph Answer</div>
                <div style="display: flex; gap: 6px;">
                  ${isAggregation ? '<span style="font-size: 10px; padding: 2px 6px; background: #fef5e7; color: #d69e2e; border-radius: 4px; font-weight: 600;">AGGREGATION</span>' : ''}
                </div>
              </div>
              <div style="font-size: 13px; line-height: 1.2; color: #4a5568;">${answer}</div>
            </div>

            ${visual.nodes.length > 0 ? `
              <div style="margin-bottom: 16px; padding: 12px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div style="font-size: 12px; font-weight: 600; color: #718096;">Interactive Network Graph</div>
                  <div style="font-size: 11px; color: #a0aec0;">
                    ${visual.nodes.length} nodes ‚Ä¢ ${visual.edges.length} relationships
                  </div>
                </div>
                <div id="${graphId}" style="height: 400px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;"></div>
              </div>
            ` : ''}

            ${cypher ? `
              <details style="margin-top: 12px;">
                <summary style="font-size: 12px; color: #718096; cursor: pointer; padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">üîç Generated Cypher Query</summary>
                <div style="margin-top: 8px; padding-top: 1.5rem; padding-bottom: 1.5rem; position: relative;">
                  <button id="copy-cypher-btn-${graphId}" data-cypher-text="${this.escapeHtml(cypher)}" style="position: absolute; top: calc(1.5rem + 8px); right: 8px; font-size: 10px; padding: 4px 6px; border: 1px solid #4a5568; background: #2d3748; color: white; border-radius: 3px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#4a5568'" onmouseout="this.style.background='#2d3748'">üìã Copy</button>
                  <pre style="font-size: 10px; background: #1a202c; color: #e2e8f0; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 0; line-height: 1.4;">${this.escapeHtml(cypher)}</pre>
                </div>
              </details>
            ` : ''}
          </div>
        `;
      }
      
      renderVisNetwork(containerId, visual) {
        const container = document.getElementById(containerId);
        if (!container || typeof vis === 'undefined') {
          console.error('Cannot render graph: container or vis.js not found');
          return;
        }

        console.log('Rendering vis-network with:', {
          nodes: visual.nodes.length,
          edges: visual.edges.length,
          edgeData: visual.edges
        });

        // Transform data for vis-network
        const nodes = new vis.DataSet(
          visual.nodes.map(node => {
            const isComplex = node.granularity === 'complex';
            const baseColor = isComplex ? '#f37f73' : this.getNodeColor(node.group);

            return {
              id: node.id,
              label: isComplex ? '‚ö° ' + node.label : node.label,
              title: node.title || node.label,
              group: node.group,
              granularity: node.granularity,
              properties: node.properties,
              color: {
                background: baseColor,
                border: this.darkenColor(baseColor),
                highlight: {
                  background: this.lightenColor(baseColor),
                  border: baseColor
                }
              },
              font: {
                color: isComplex ? '#ffffff' : '#f37f73',
                size: isComplex ? 15 : 14,
                face: 'Raleway',
                weight: isComplex ? '600' : '500'
              },
              size: isComplex ? 30 : (node.size || 25),
              borderWidth: isComplex ? 3 : 2
            };
          })
        );

        const edges = new vis.DataSet(
          visual.edges.map(edge => ({
            id: edge.id,
            from: edge.from,
            to: edge.to,
            label: edge.label,
            title: edge.title || edge.label,
            arrows: {
              to: {
                enabled: true,
                scaleFactor: 1.0
              }
            },
            color: {
              color: '#64748b',
              highlight: '#f37f73',
              hover: '#f37f73'
            },
            width: 2,
            font: {
              size: 12,
              align: 'middle',
              background: '#ffffff',
              strokeWidth: 3,
              strokeColor: '#ffffff',
              color: '#475569'
            },
            smooth: {
              type: 'cubicBezier',
              roundness: 0.5
            }
          }))
        );

        const data = { nodes, edges };

        const options = {
          nodes: {
            shape: 'dot',
            scaling: {
              min: 20,
              max: 40
            },
            borderWidth: 2,
            shadow: true
          },
          edges: {
            width: 3,
            shadow: true,
            smooth: {
              type: 'continuous'
            },
            color: {
              inherit: false
            }
          },
          physics: {
            enabled: true,
            stabilization: {
              iterations: 100,
              fit: true
            },
            barnesHut: {
              gravitationalConstant: -2000,
              centralGravity: 0.3,
              springLength: 120,
              springConstant: 0.04,
              damping: 0.09,
              avoidOverlap: 0.5
            }
          },
          interaction: {
            hover: true,
            tooltipDelay: 100,
            hideEdgesOnDrag: true,
            navigationButtons: true,
            keyboard: true
          },
          layout: {
            improvedLayout: true
          }
        };

        // Create network
        const network = new vis.Network(container, data, options);

        // Add click handler for nodes
        network.on('click', (params) => {
          console.log('Graph clicked:', params);
          if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            console.log('Node clicked:', node);

            if (node) {
              // Show properties sidebar
              this.showNodePropertiesPanel(node, graphId);
            }
          }
        });

        // Fit network to container after stabilization
        network.once('stabilizationIterationsDone', () => {
          network.fit({
            animation: {
              duration: 500,
              easingFunction: 'easeInOutQuad'
            }
          });
        });
      }

      darkenColor(color) {
        // Simple darken function for border
        const hex = color.replace('#', '');
        const r = Math.max(0, parseInt(hex.substr(0, 2), 16) - 30);
        const g = Math.max(0, parseInt(hex.substr(2, 2), 16) - 30);
        const b = Math.max(0, parseInt(hex.substr(4, 2), 16) - 30);
        return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
      }

      lightenColor(color) {
        // Simple lighten function for highlight
        const hex = color.replace('#', '');
        const r = Math.min(255, parseInt(hex.substr(0, 2), 16) + 30);
        const g = Math.min(255, parseInt(hex.substr(2, 2), 16) + 30);
        const b = Math.min(255, parseInt(hex.substr(4, 2), 16) + 30);
        return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
      }

      getNodeColor(group) {
        const colors = {
          'Construct': '#3182ce',
          'InformationUse': '#e53e3e',
          'ActionStatement': '#38a169',
          'DictionaryItem': '#d69e2e',
          'Content': '#805ad5',
          'Deliverable': '#dd6b20',
          'Resource': '#319795',
          'Generic': '#718096'
        };
        return colors[group] || '#718096';
      }

      showNodePropertiesPanel(node, graphId) {
        // Create or get sidebar
        let sidebar = document.getElementById('properties-sidebar');

        if (!sidebar) {
          sidebar = document.createElement('div');
          sidebar.id = 'properties-sidebar';
          sidebar.style.cssText = 'position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: #ffffff; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 10000; transition: right 0.3s ease; overflow-y: auto; padding: 20px;';
          document.body.appendChild(sidebar);
        }

        // Build properties HTML
        const props = node.properties || {};
        const excludeKeys = ['name', 'title', 'label'];
        const propEntries = Object.entries(props).filter(([key]) => !excludeKeys.includes(key));

        let html = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0;">
            <div style="font-weight: 700; color: #1a202c; font-size: 16px;">
              üìã Node Properties
            </div>
            <button onclick="document.getElementById('properties-sidebar').style.right='-400px'" style="font-size: 12px; padding: 6px 12px; border: 1px solid #e2e8f0; background: #f37f73; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Close</button>
          </div>
          <div style="margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Name</div>
            <div style="font-size: 14px; font-weight: 600; color: #1a202c;">${this.escapeHtml(node.label)}</div>
          </div>
          <div style="margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Type</div>
            <div style="font-size: 14px; font-weight: 600; color: #1a202c;">${this.escapeHtml(node.group || 'Unknown')}</div>
          </div>
        `;

        if (node.granularity) {
          html += `
            <div style="margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
              <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Granularity</div>
              <div style="font-size: 14px; font-weight: 600; color: #f37f73;">${this.escapeHtml(node.granularity)}</div>
            </div>
          `;
        }

        if (propEntries.length === 0) {
          html += '<div style="color: #718096; font-size: 13px; font-style: italic; padding: 12px; text-align: center;">No additional properties</div>';
        } else {
          html += '<div style="margin-top: 20px;"><div style="font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 12px;">Additional Properties (' + propEntries.length + ')</div>';

          propEntries.forEach(([key, value]) => {
            const displayValue = typeof value === 'object' ? JSON.stringify(value) : String(value);
            html += `
              <div style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 6px;">
                <div style="font-size: 11px; color: #718096; margin-bottom: 4px; text-transform: uppercase;">${this.escapeHtml(key)}</div>
                <div style="font-size: 13px; color: #1a202c; word-break: break-word;">${this.escapeHtml(displayValue.length > 200 ? displayValue.substring(0, 200) + '...' : displayValue)}</div>
              </div>
            `;
          });

          html += '</div>';
        }

        sidebar.innerHTML = html;
        // Slide in
        setTimeout(() => { sidebar.style.right = '0'; }, 10);
      }

      async expandComplexNode(nodeId, nodes, edges, network) {
        console.log('Expanding complex node:', nodeId);

        // Show loading indicator
        const expandMsg = document.createElement('div');
        expandMsg.id = 'expand-loading';
        expandMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f37f73; color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999;';
        expandMsg.textContent = '‚ö° Expanding complex node...';
        document.body.appendChild(expandMsg);

        try {
          // Fetch connected nodes from backend
          const response = await fetch('https://australia-southeast1-bimei-neo4j.cloudfunctions.net/dashboardApi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: `MATCH (n)-[r]-(connected) WHERE elementId(n) = '${nodeId}' RETURN n, r, connected LIMIT 10`
            })
          });

          if (!response.ok) throw new Error('Failed to fetch connected nodes');

          const data = await response.json();

          // Process and add new nodes/edges to the graph
          if (data.graph && data.graph.nodes) {
            data.graph.nodes.forEach(newNode => {
              if (!nodes.get(newNode.id)) {
                nodes.add({
                  ...newNode,
                  color: {
                    background: this.getNodeColor(newNode.group),
                    border: this.darkenColor(this.getNodeColor(newNode.group))
                  }
                });
              }
            });
          }

          if (data.graph && data.graph.edges) {
            data.graph.edges.forEach(newEdge => {
              if (!edges.get(newEdge.id)) {
                edges.add(newEdge);
              }
            });
          }

          expandMsg.style.background = '#38a169';
          expandMsg.textContent = '‚úì Expanded successfully';
          setTimeout(() => expandMsg.remove(), 2000);

        } catch (error) {
          console.error('Error expanding node:', error);
          expandMsg.style.background = '#e53e3e';
          expandMsg.textContent = '‚úó Expansion failed';
          setTimeout(() => expandMsg.remove(), 3000);
        }
      }

      escapeHtml(text) {
        return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
      }

      escapeForJs(text) {
        return String(text).replace(/'/g, "\\''").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
      }
    }

    // Global Dashboard Instance
    window.BIMeiDashboard = null;

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      window.BIMeiDashboard = new BIMeiDashboard();
    });

    // Export for future module registration
    window.BIMeiKB = {
      registerModule: (name, moduleInstance) => {
        if (window.BIMeiDashboard) {
          window.BIMeiDashboard.registerModule(name, moduleInstance);
        }
      }
    };
  </script>
</body>
</html>