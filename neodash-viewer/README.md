# NeoDash Viewer

Flask API for graph-based question answering with automatic visualization generation using Neo4j, LangChain, and Google Gemini AI.

**Part of**: [BIMei Microtools Collection](../)
**Stack**: Python, Flask, Neo4j, LangChain, Google Gemini AI
**Deployment**: Vercel serverless functions
**Status**: Active

---

## Overview

This tool provides a REST API endpoint that accepts natural language questions, generates Cypher queries using Google Gemini AI, executes them against a Neo4j graph database, and returns both text answers and interactive graph visualizations.

### Key Features

- **Natural Language Querying**: Ask questions in plain English about your knowledge graph
- **AI-Powered Cypher Generation**: Uses Google Gemini 2.5 Flash to generate Cypher queries
- **LangChain Integration**: Built on LangChain's GraphCypherQAChain
- **Smart Visualization**: Automatically determines the best visualization strategy
- **Dual-Mode Rendering**:
  - **Safe Mode**: For aggregation queries (COUNT, SUM, AVG), shows sample graph
  - **Smart Mode**: For entity queries, shows actual query results
- **CORS Enabled**: Can be embedded in web applications
- **Vercel Deployment**: Serverless function ready for instant deployment

---

## Use Cases

1. **Interactive Graph Exploration**: Let users query your knowledge graph conversationally
2. **Dashboard Integration**: Embed graph Q&A in existing dashboards
3. **Knowledge Discovery**: Help users find relationships and patterns
4. **Educational Tools**: Make graph databases accessible to non-technical users
5. **API Backend**: Power chatbots and conversational interfaces

---

## Architecture

```
┌──────────────────┐
│  Web Client      │
│  (POST /ask)     │
└────────┬─────────┘
         │ {"question": "What is BIM?"}
         ▼
┌──────────────────┐
│  Flask API       │
│  (index.py)      │
└────────┬─────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐  ┌──────────┐
│Gemini │  │  Neo4j   │
│ 2.5   │  │  Graph   │
└───┬───┘  └────┬─────┘
    │           │
    └─────┬─────┘
          ▼
    ┌─────────────┐
    │ Response:   │
    │ - Answer    │
    │ - Cypher    │
    │ - Visual    │
    └─────────────┘
```

---

## Files

```
neodash-viewer/
├── api/
│   └── index.py          # Flask API endpoint
├── vercel.json          # Vercel deployment configuration
├── requirements.txt     # Python dependencies
└── README.md            # This file
```

---

## Quick Start

### Prerequisites

- **Python 3.8+** installed
- **Neo4j Database** (AuraDB or self-hosted)
- **Google API Key** (for Gemini AI)

### Local Development

1. **Navigate to the directory**
   ```bash
   cd neodash-viewer
   ```

2. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

3. **Set environment variables**
   ```bash
   export NEO4J_URI="neo4j+s://your-instance.databases.neo4j.io"
   export NEO4J_USER="neo4j"
   export NEO4J_PASSWORD="your-neo4j-password"
   export GOOGLE_API_KEY="your-google-api-key"
   ```

4. **Run the Flask app**
   ```bash
   python api/index.py
   ```

5. **Test the API**
   ```bash
   curl -X POST http://localhost:5000/ask \
     -H "Content-Type: application/json" \
     -d '{"question": "What is BIM?"}'
   ```

---

## API Documentation

### Endpoint

**POST** `/ask`

### Request Format

```json
{
  "question": "What is the relationship between BIM and COBie?"
}
```

### Response Format

```json
{
  "answer": "BIM (Building Information Modelling) and COBie (Construction Operations Building Information Exchange) are related in that COBie is a data exchange standard used within BIM workflows...",
  "visual": {
    "nodes": [
      {
        "id": "4:abc123:456",
        "label": "BIM",
        "group": "DictionaryItem",
        "title": "{'name': 'BIM', 'definition': '...'}"
      },
      {
        "id": "4:abc123:789",
        "label": "COBie",
        "group": "DictionaryItem",
        "title": "{'name': 'COBie', 'definition': '...'}"
      }
    ],
    "edges": [
      {
        "from": "4:abc123:456",
        "to": "4:abc123:789",
        "label": "RELATES_TO"
      }
    ]
  }
}
```

### Response Fields

- **answer** (string): Natural language answer generated by Gemini AI
- **visual** (object): Graph visualization data
  - **nodes** (array): Graph nodes with id, label, group (type), and title (tooltip)
  - **edges** (array): Graph relationships with from, to, and label

### Error Response

```json
{
  "error": "Error message here"
}
```

---

## Visualization Modes

### Safe Mode (Aggregation Queries)

Triggered when query contains: `COUNT`, `SUM`, `AVG`, `MAX`, `MIN`

**Behavior**: Returns a sample of the graph (25 nodes/relationships) instead of trying to visualize aggregated results.

**Example Query**: "How many dictionary items are in the graph?"
**Cypher Generated**: `MATCH (d:DictionaryItem) RETURN COUNT(d)`
**Visual Query**: `MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 25`

### Smart Mode (Entity Queries)

Triggered for all other queries (entity lookups, relationship queries, etc.)

**Behavior**: Modifies the AI-generated Cypher to return actual entities by replacing the RETURN clause with `RETURN * LIMIT 50`.

**Example Query**: "What is BIM related to?"
**Cypher Generated**: `MATCH (n:DictionaryItem {name: "BIM"})-[r:RELATES_TO]->(m) RETURN m.name`
**Visual Query**: `MATCH (n:DictionaryItem {name: "BIM"})-[r:RELATES_TO]->(m) RETURN * LIMIT 50`

---

## Deployment

### Vercel (Recommended)

1. **Install Vercel CLI**
   ```bash
   npm install -g vercel
   ```

2. **Login to Vercel**
   ```bash
   vercel login
   ```

3. **Deploy**
   ```bash
   vercel --prod
   ```

4. **Set environment variables in Vercel dashboard**
   - `NEO4J_URI`
   - `NEO4J_USER`
   - `NEO4J_PASSWORD`
   - `GOOGLE_API_KEY`

### Docker

```dockerfile
FROM python:3.10-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY api/ ./api/

EXPOSE 5000

CMD ["python", "api/index.py"]
```

Build and run:
```bash
docker build -t neodash-viewer .
docker run -p 5000:5000 \
  -e NEO4J_URI="neo4j+s://..." \
  -e NEO4J_USER="neo4j" \
  -e NEO4J_PASSWORD="..." \
  -e GOOGLE_API_KEY="..." \
  neodash-viewer
```

### Google Cloud Run

```bash
gcloud run deploy neodash-viewer \
  --source . \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars NEO4J_URI="${NEO4J_URI}",NEO4J_USER="${NEO4J_USER}",NEO4J_PASSWORD="${NEO4J_PASSWORD}",GOOGLE_API_KEY="${GOOGLE_API_KEY}"
```

---

## Integration Examples

### JavaScript/React

```javascript
async function askGraph(question) {
  const response = await fetch('https://your-api.vercel.app/ask', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ question })
  });

  const data = await response.json();

  // Display answer
  console.log(data.answer);

  // Render graph with vis-network or similar
  renderGraph(data.visual.nodes, data.visual.edges);
}

askGraph("What is BIM?");
```

### Python Client

```python
import requests

response = requests.post('https://your-api.vercel.app/ask', json={
    "question": "What is the relationship between BIM and COBie?"
})

result = response.json()
print(result['answer'])
print(f"Nodes: {len(result['visual']['nodes'])}")
print(f"Edges: {len(result['visual']['edges'])}")
```

### cURL

```bash
curl -X POST https://your-api.vercel.app/ask \
  -H "Content-Type: application/json" \
  -d '{"question": "What is BIM related to?"}'
```

---

## Configuration

### Environment Variables

Required in `.env` or deployment platform:

```env
NEO4J_URI=neo4j+s://your-instance.databases.neo4j.io
NEO4J_USER=neo4j
NEO4J_PASSWORD=your-neo4j-password
GOOGLE_API_KEY=your-google-api-key
```

### Vercel Configuration

The `vercel.json` file routes all requests to the Flask app:

```json
{
  "rewrites": [{ "source": "/(.*)", "destination": "/api/index.py" }]
}
```

---

## Troubleshooting

### Issue: "Error: Missing environment variables"
**Solution**:
- Verify all required environment variables are set
- In Vercel: Settings → Environment Variables
- Locally: Use `.env` file or export commands

### Issue: "Neo4j connection failed"
**Solution**:
- Check `NEO4J_URI` format (should start with `neo4j+s://` for AuraDB)
- Verify `NEO4J_PASSWORD` is correct
- Ensure database is running and accessible

### Issue: "Google API key invalid"
**Solution**:
- Verify API key has Generative Language API enabled
- Check for typos in `GOOGLE_API_KEY`
- Ensure billing is enabled in GCP project

### Issue: "Visual fetch failed" but answer still returns
**Solution**:
- This is expected behavior when Smart Mode query fails
- The API gracefully falls back to text-only response
- Check Neo4j logs for query errors
- Verify graph has data matching the query

### Issue: Empty visualization despite having data
**Solution**:
- Check if query is aggregation (uses Safe Mode)
- Verify node properties include `name` or `title` fields
- Increase LIMIT in visualization query (lines 48, 52 in index.py)

---

## Performance

- **Query Time**: 2-5 seconds (depends on complexity)
- **Gemini API**: ~1-2 seconds for Cypher generation
- **Neo4j Query**: ~0.5-2 seconds for data retrieval
- **Visualization Limit**: 50 nodes/edges max (configurable)
- **Cold Start**: ~3-5 seconds on serverless platforms

---

## Dependencies

```
flask>=3.0.0
flask-cors>=4.0.0
neo4j>=5.0.0
langchain>=0.1.0
langchain-community>=0.0.10
langchain-google-genai>=1.0.0
```

---

## Security

### CORS Configuration
Currently allows all origins (`CORS(app)`). For production, restrict to specific domains:

```python
CORS(app, origins=["https://yourdomain.com"])
```

### API Security
Consider adding:
- API key authentication
- Rate limiting
- Input sanitization
- Query complexity limits

### Dangerous Requests Flag
The code uses `allow_dangerous_requests=True` in GraphCypherQAChain. This is necessary for the AI to generate arbitrary Cypher queries but should be used with caution in production. Consider:
- Query validation
- Whitelist/blacklist patterns
- User permission checks

---

## Related Tools

- [bimei-kb-dashboard](../bimei-kb-dashboard/) - Full dashboard using this API pattern
- [knowledge_graph_streamlit_viewer](../knowledge_graph_streamlit_viewer/) - Alternative visualization approach
- [vertex-graph-builder](../vertex-graph-builder/) - Build the knowledge graph
- [vertex_cx_chatbot](../vertex_cx_chatbot/) - Chatbot using similar graph Q&A

---

## Support

**Issues**: Create an issue in the GitHub repository
**Flask**: [Flask Documentation](https://flask.palletsprojects.com/)
**LangChain**: [LangChain Documentation](https://python.langchain.com/)
**Neo4j**: [Neo4j Documentation](https://neo4j.com/docs/)
**Vercel**: [Vercel Documentation](https://vercel.com/docs)

---

## License

Licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)

Part of the BIMei Microtools Collection. Licensed under CC BY-NC-SA 4.0.
