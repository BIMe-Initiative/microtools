openapi: 3.0.0
info:
  title: BIMei Knowledge Graph Tool (direct)
  version: 1.2.0
  description: 'Use this tool ONLY for complex questions involving relationships,
    hidden connections, multi-hop reasoning, counts/aggregations across entities,
    or shortest-path requests (e.g. "How is X related to Y?", "Find the common link
    between A and B", "Show shortest path"). Do NOT use this for simple definitions
    or page summaries; use the Data Store for those. This tool calls the GraphRAG/Neo4j
    layer directly and returns graph-grounded results.



    This version supports ranked paths with tier + score_norm and optional evidence_html.'
servers:
- url: https://us-central1-bimei-ai.cloudfunctions.net/graphQuery
paths:
  /:
    post:
      summary: Query the BIMei Knowledge Graph
      description: 'Sends a natural language graph question to the Knowledge Graph
        service. The service should resolve candidate nodes and either return shortest
        paths, neighbourhood evidence, or an error envelope.

        '
      operationId: queryGraph
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GraphQueryRequest'
            examples:
              shortestPath:
                value:
                  query: 'X: show me the shortest path (<=10 hops) between Model Uses
                    and Knowledge Sets'
              aggregation:
                value:
                  query: How many Action Statements exist across the BIMei knowledge
                    base?
              neighbours:
                value:
                  query: What concepts are directly connected to Knowledge Sets?
      responses:
        '200':
          description: 'Tool response envelope. Check `status` for PATH_FOUND, NO_PATH,
            TERM_NOT_FOUND, or ERROR. ERROR is returned in-body (still HTTP 200) so
            the agent can read details reliably.

            '
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphQueryResponse'
              examples:
                pathFound:
                  value:
                    status: PATH_FOUND
                    source: BIMei Knowledge Graph
                    answer: Found a shortest path between Model Uses and Knowledge
                      Sets.
                    hop_limit_used: 10
                    resolved_candidates:
                      x:
                      - id: '123'
                        label: Model Uses
                        type: InformationUse
                      y:
                      - id: '456'
                        label: Knowledge Sets
                        type: KnowledgeSet
                    paths:
                    - hop_count: 4
                      chain:
                      - node:
                          id: '123'
                          label: Model Uses
                          type: InformationUse
                      - edge:
                          type: CONSIDERED_AS
                      - node:
                          label: Knowledge Blocks
                          type: KnowledgeBlock
                      - edge:
                          type: PART_OF
                      - node:
                          label: The BIM Ontology
                          type: Ontology
                      - edge:
                          type: CONTAINS
                      - node:
                          id: '456'
                          label: Knowledge Sets
                          type: KnowledgeSet
                      tier: high
                      score_norm: 0.86
                      score_raw: 1.42
                    evidence_html: <div class="ont-path" data-path-index="1">...</div>
                    paths_count: 1
                    paths_shown: 1
                noPath:
                  value:
                    status: NO_PATH
                    source: BIMei Knowledge Graph
                    answer: No path found within hop limit.
                    hop_limit_used: 10
                    resolved_candidates:
                      x:
                      - label: Model Uses
                        type: InformationUse
                      y:
                      - label: Knowledge Sets
                        type: KnowledgeSet
                    neighbourhood:
                      x:
                      - edge:
                          type: PART_OF
                        to:
                          label: The BIM Ontology
                          type: Ontology
                      y:
                      - edge:
                          type: CONTAINS
                        to:
                          label: Knowledge Blocks
                          type: KnowledgeBlock
                termNotFound:
                  value:
                    status: TERM_NOT_FOUND
                    source: BIMei Knowledge Graph
                    answer: Could not resolve one or both endpoint terms.
                    resolved_candidates:
                      x: []
                      y: []
                errorInBody:
                  value:
                    status: ERROR
                    source: BIMei Knowledge Graph
                    answer: ''
                    debug:
                      message: Neo4j query failed
                      neo4j_error: Variable `toLower` not defined ...
                      cypher: MATCH p = allShortestPaths(...) WHERE ...
                      trace: 86a58b5c16a68fc5704611e8ada62128;o=1
        '400':
          description: Invalid request (e.g. missing query)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphQueryResponse'
              examples:
                badRequest:
                  value:
                    status: ERROR
                    source: BIMei Knowledge Graph
                    answer: ''
                    debug:
                      message: 'Missing required field: query'
components:
  schemas:
    GraphQueryRequest:
      type: object
      additionalProperties: false
      required:
      - query
      properties:
        query:
          type: string
          minLength: 1
          description: The natural language question to ask the graph.
    GraphQueryResponse:
      type: object
      additionalProperties: false
      required:
      - status
      - source
      properties:
        status:
          type: string
          description: Machine-readable outcome for the graph query.
          enum:
          - PATH_FOUND
          - NO_PATH
          - TERM_NOT_FOUND
          - ERROR
        source:
          type: string
          description: Source stamp for the response.
          example: BIMei Knowledge Graph
        answer:
          type: string
          description: Human-readable summary. May be empty for NO_PATH/TERM_NOT_FOUND/ERROR.
        hop_limit_used:
          type: integer
          description: Hop limit used during path search (if applicable).
          minimum: 0
        resolved_candidates:
          type: object
          description: Candidate node matches for key terms in the question (if applicable).
          additionalProperties: false
          properties:
            x:
              type: array
              items:
                $ref: '#/components/schemas/CandidateNode'
            y:
              type: array
              items:
                $ref: '#/components/schemas/CandidateNode'
        paths:
          type: array
          description: One or more shortest paths if found.
          items:
            $ref: '#/components/schemas/GraphPath'
        neighbourhood:
          type: object
          description: Small adjacency samples when no path exists (or to help rephrase
            queries).
          additionalProperties: false
          properties:
            x:
              type: array
              items:
                $ref: '#/components/schemas/NeighbourEdge'
            y:
              type: array
              items:
                $ref: '#/components/schemas/NeighbourEdge'
        debug:
          type: object
          description: Optional diagnostic information (errors, cypher, trace).
          additionalProperties: false
          properties:
            message:
              type: string
            neo4j_error:
              type: string
            cypher:
              type: string
              description: Cypher query (truncate if needed).
            trace:
              type: string
              description: Trace/context identifier (optional).
        paths_by_tier:
          type: object
          description: Paths grouped by tier for UI display.
          additionalProperties: true
        paths_count:
          type: integer
          minimum: 0
          description: Total number of ranked paths returned.
        paths_shown:
          type: integer
          minimum: 0
          description: Number of paths intended for end-user display.
        evidence_html:
          type: string
          description: Optional HTML evidence block (sanitised by client).
        graph_data:
          type: object
          description: Structured graph visualization data.
          additionalProperties: false
          properties:
            nodes:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  type:
                    type: string
                  label:
                    type: string
            edges:
              type: array
              items:
                type: object
                properties:
                  source:
                    type: string
                  relation:
                    type: string
                  target:
                    type: string
        evidence:
          type: object
          description: Structured evidence metrics.
          additionalProperties: false
          properties:
            score:
              type: number
            confidence:
              type: string
            semantic_type:
              type: string
            metrics:
              type: object
              properties:
                hops:
                  type: integer
                raw:
                  type: number
                normalised:
                  type: number
                decay:
                  type: number
        weights_source:
          type: string
          description: Where weights were loaded from.
        weights_version:
          type: string
          description: Weights version identifier.
        weights_updated_utc:
          type: string
          description: Weights last-updated timestamp (UTC).
    CandidateNode:
      type: object
      additionalProperties: false
      required:
      - label
      - type
      properties:
        id:
          type: string
          description: Optional stable node identifier (include only when needed for
            disambiguation).
        label:
          type: string
        type:
          type: string
    GraphPath:
      type: object
      additionalProperties: false
      required:
      - hop_count
      - chain
      properties:
        hop_count:
          type: integer
          minimum: 0
        chain:
          type: array
          description: Alternating node/edge/node/edge... representation.
          items:
            oneOf:
            - $ref: '#/components/schemas/PathNode'
            - $ref: '#/components/schemas/PathEdge'
        tier:
          type: string
          description: Tier label derived from score_norm (e.g. high/medium/low/minimal).
        score_norm:
          type: number
          description: Normalised path score (0..1).
        score_raw:
          type: number
          description: Raw (pre-normalisation) path score.
    PathNode:
      type: object
      additionalProperties: false
      required:
      - node
      properties:
        node:
          $ref: '#/components/schemas/CandidateNode'
    PathEdge:
      type: object
      additionalProperties: false
      required:
      - edge
      properties:
        edge:
          type: object
          additionalProperties: false
          required:
          - type
          properties:
            type:
              type: string
    NeighbourEdge:
      type: object
      additionalProperties: false
      required:
      - edge
      - to
      properties:
        edge:
          type: object
          additionalProperties: false
          required:
          - type
          properties:
            type:
              type: string
        to:
          $ref: '#/components/schemas/CandidateNode'
